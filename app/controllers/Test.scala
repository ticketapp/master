package controllers

import java.io.{IOException, FileNotFoundException}
import java.math.MathContext
import java.text.Normalizer
import java.util.Date
import java.util.regex.Pattern
import play.api.libs.iteratee.{Concurrent, Iteratee, Enumerator}
import play.api.libs.ws.WS
import play.api.libs.ws.Response
import play.api.mvc._
import play.libs.F.Promise
import scala.concurrent.Future
import play.api.libs.json._
import play.api.libs.concurrent.Execution.Implicits._
import models.{Track, Artist, Event}
import scala.io.Source
import play.api.mvc.Results._
import scala.util.{Success, Failure}
import services.Utilities._
import play.api.libs.functional.syntax._

object Test extends Controller {
  /*def test1 = WebSocket.using[String] { request =>
    //Concurrent.broadcast returns (Enumerator, Concurrent.Channel)
    val (out,channel) = Concurrent.broadcast[String]

    //log the message to stdout and send response back to client
    val in = Iteratee.foreach[String] {
      msg => println(msg)
        //the Enumerator returned by Concurrent.broadcast subscribes to the channel and will
        //receive the pushed messages
        channel push("c'est toi le : " + msg)
    }
    (in,out)
  }*/

  def test1 = Action  {
    val a = Json.parse("""[{"kind":"track","id":177624049,"created_at":"2014/11/19 08:38:50 +0000","user_id":1788517,"duration":230760,"commentable":true,"state":"finished","original_content_size":43746460,"last_modified":"2015/03/15 12:18:31 +0000","sharing":"public","tag_list":"\"Rone 2015\" \"Rone Premiere\"","permalink":"rone-ouija-taken-from-creatures-9-feb-2015","streamable":true,"embeddable_by":"all","downloadable":false,"purchase_url":"http://hyperurl.co/z97vt0","label_id":null,"purchase_title":"I-Tunes","genre":"Rone Creatures","title":"\"OUIJA\"  [taken from Creatures, out 9 Feb 2015]","description":"RONE_\"Creatures\"\nLP / CD out 9 Feb. 2015\n\nPRE-ORDER I-TUNES\n\nFRANCE, BELGIUM, CANADA = itunes.apple.com/album/creatures/id941927785\nREST OF THE WORLD (USA …) = itunes.apple.com/album/creatures/id941939619","label_name":"InFiné Music","release":null,"track_type":null,"key_signature":null,"isrc":null,"video_url":null,"bpm":null,"release_year":2015,"release_month":2,"release_day":9,"original_format":"wav","license":"all-rights-reserved","uri":"https://api.soundcloud.com/tracks/177624049","user":{"id":1788517,"kind":"user","permalink":"rone-music","username":"Rone","last_modified":"2015/02/10 08:56:43 +0000","uri":"https://api.soundcloud.com/users/1788517","permalink_url":"http://soundcloud.com/rone-music","avatar_url":"https://i1.sndcdn.com/avatars-000001787298-keul06-large.jpg"},"permalink_url":"http://soundcloud.com/rone-music/rone-ouija-taken-from-creatures-9-feb-2015","artwork_url":"https://i1.sndcdn.com/artworks-000097629906-w0yqgp-large.jpg","waveform_url":"https://w1.sndcdn.com/UDimWAnmSbVx_m.png","stream_url":"https://api.soundcloud.com/tracks/177624049/stream","playback_count":134316,"download_count":0,"favoritings_count":3053,"comment_count":128,"attachments_uri":"https://api.soundcloud.com/tracks/177624049/attachments","policy":"ALLOW"},{"kind":"track","id":152961416,"created_at":"2014/06/05 15:34:24 +0000","user_id":1788517,"duration":292990,"commentable":true,"state":"finished","original_content_size":51868820,"last_modified":"2015/02/20 15:50:52 +0000","sharing":"public","tag_list":"Etienne Daho Rone","permalink":"daho-by-rone-en-surface","streamable":false,"embeddable_by":"all","downloadable":false,"purchase_url":null,"label_id":null,"purchase_title":null,"genre":"electro","title":"Daho by Rone - En Surface","description":"(Dominique A- Etienne Daho/ Dominique A)\r\nSatori Song/DR\r\n(p) 2013 Polydor, un label Universal Music France\r\n\r\nArtwork by Liliwood","label_name":"","release":"","track_type":"remix","key_signature":"","isrc":"","video_url":null,"bpm":null,"release_year":null,"release_month":null,"release_day":null,"original_format":"wav","license":"all-rights-reserved","uri":"https://api.soundcloud.com/tracks/152961416","user":{"id":1788517,"kind":"user","permalink":"rone-music","username":"Rone","last_modified":"2015/02/10 08:56:43 +0000","uri":"https://api.soundcloud.com/users/1788517","permalink_url":"http://soundcloud.com/rone-music","avatar_url":"https://i1.sndcdn.com/avatars-000001787298-keul06-large.jpg"},"permalink_url":"http://soundcloud.com/rone-music/daho-by-rone-en-surface","artwork_url":"https://i1.sndcdn.com/artworks-000081537477-l4fmqp-large.jpg","waveform_url":"https://w1.sndcdn.com/hj5vXX3L45dI_m.png","playback_count":154997,"download_count":0,"favoritings_count":2944,"comment_count":128,"attachments_uri":"https://api.soundcloud.com/tracks/152961416/attachments","policy":"ALLOW"},{"kind":"track","id":126167361,"created_at":"2013/12/23 14:13:34 +0000","user_id":1788517,"duration":2462506,"commentable":true,"state":"finished","original_content_size":98493154,"last_modified":"2014/11/29 17:12:04 +0000","sharing":"public","tag_list":"rone tsugi mix podcast autechre holden clark caribou hopkins downliners kuage sekt vessel banabila blind digital citizen idm experimental ambiant electro","permalink":"rone-boarding-pass-40mn-mix","streamable":true,"embeddable_by":"all","downloadable":true,"purchase_url":null,"label_id":null,"purchase_title":null,"genre":"mix","title":"Rone - Boarding Pass (40mn mix)","description":"CD sampler mixed by Rone for Tsugi mag (n°66 - oct 2013)","label_name":"","release":"","track_type":"","key_signature":"","isrc":"","video_url":null,"bpm":null,"release_year":null,"release_month":null,"release_day":null,"original_format":"mp3","license":"all-rights-reserved","uri":"https://api.soundcloud.com/tracks/126167361","user":{"id":1788517,"kind":"user","permalink":"rone-music","username":"Rone","last_modified":"2015/02/10 08:56:43 +0000","uri":"https://api.soundcloud.com/users/1788517","permalink_url":"http://soundcloud.com/rone-music","avatar_url":"https://i1.sndcdn.com/avatars-000001787298-keul06-large.jpg"},"permalink_url":"http://soundcloud.com/rone-music/rone-boarding-pass-40mn-mix","artwork_url":"https://i1.sndcdn.com/artworks-000066088733-ngyxvz-large.jpg","waveform_url":"https://w1.sndcdn.com/0u2CLtKRXhcR_m.png","stream_url":"https://api.soundcloud.com/tracks/126167361/stream","download_url":"https://api.soundcloud.com/tracks/126167361/download","playback_count":71804,"download_count":4103,"favoritings_count":1859,"comment_count":189,"attachments_uri":"https://api.soundcloud.com/tracks/126167361/attachments","policy":"ALLOW"},{"kind":"track","id":126156747,"created_at":"2013/12/23 12:31:15 +0000","user_id":1788517,"duration":265376,"commentable":true,"state":"finished","original_content_size":11719956,"last_modified":"2015/03/15 15:35:32 +0000","sharing":"public","tag_list":"infiné \"tohu bohu\" rone","permalink":"bye-bye-macadam","streamable":true,"embeddable_by":"all","downloadable":false,"purchase_url":"https://itunes.apple.com/fr/album/tohu-bohu/id562022226","label_id":null,"purchase_title":null,"genre":"rone","title":"Rone - Bye Bye Macadam","description":"","label_name":"","release":"(IF1020)","track_type":"","key_signature":"","isrc":"","video_url":"http://www.youtube.com/watch?v=kfoJUeyMsOE","bpm":null,"release_year":null,"release_month":null,"release_day":null,"original_format":"mp3","license":"all-rights-reserved","uri":"https://api.soundcloud.com/tracks/126156747","user":{"id":1788517,"kind":"user","permalink":"rone-music","username":"Rone","last_modified":"2015/02/10 08:56:43 +0000","uri":"https://api.soundcloud.com/users/1788517","permalink_url":"http://soundcloud.com/rone-music","avatar_url":"https://i1.sndcdn.com/avatars-000001787298-keul06-large.jpg"},"permalink_url":"http://soundcloud.com/rone-music/bye-bye-macadam","artwork_url":"https://i1.sndcdn.com/artworks-000066085657-e16dor-large.jpg","waveform_url":"https://w1.sndcdn.com/DtwakGeJiS3Q_m.png","stream_url":"https://api.soundcloud.com/tracks/126156747/stream","playback_count":220081,"download_count":0,"favoritings_count":5839,"comment_count":111,"attachments_uri":"https://api.soundcloud.com/tracks/126156747/attachments","policy":"ALLOW"},{"kind":"track","id":76519409,"created_at":"2013/01/26 09:33:12 +0000","user_id":1788517,"duration":3727473,"commentable":true,"state":"finished","original_content_size":149088164,"last_modified":"2015/03/01 13:07:26 +0000","sharing":"public","tag_list":"rone mix infiné muslimgauze shed frost pantha jonson ability","permalink":"huto-hubo-mixtape","streamable":true,"embeddable_by":"all","downloadable":true,"purchase_url":null,"label_id":null,"purchase_title":null,"genre":"Mix ","title":"Rone - Huto Hubo mixtape (january 2013)","description":"Rone - Huto Hubo mixtape. \r\n\r\n  1)  Muslimgauze - A Small Intricate Box, Which Contains Old Blue Opium \r\n  2)  Fire flower revue - Beating of small wings\r\n  3)  Plankt - unreleased\r\n  4)  Bee Mask - Vaporware\r\n  5)  Shed - Another Wedged Chicken\r\n  6)  Ability II - b - pressure dub\r\n  7)  Cos-Ber-Zam - Ne Noya (Daphni Mix)\r\n  8)  Ry_Frank_Wiedemann_-_Howling_(Ame_remix)\r\n  9)  Mathew Jonson - Symphony for the apocalypse\r\n10)  Ben Frost - Theory of Machines\r\n11)  John Maus - Hey Moon\r\n12)  Rone - Nakt\r\n13)  Pantha du Prince - Saturn Strobe\r\n","label_name":"","release":"","track_type":"podcast","key_signature":"","isrc":"","video_url":null,"bpm":null,"release_year":null,"release_month":null,"release_day":null,"original_format":"mp3","license":"all-rights-reserved","uri":"https://api.soundcloud.com/tracks/76519409","user":{"id":1788517,"kind":"user","permalink":"rone-music","username":"Rone","last_modified":"2015/02/10 08:56:43 +0000","uri":"https://api.soundcloud.com/users/1788517","permalink_url":"http://soundcloud.com/rone-music","avatar_url":"https://i1.sndcdn.com/avatars-000001787298-keul06-large.jpg"},"permalink_url":"http://soundcloud.com/rone-music/huto-hubo-mixtape","artwork_url":null,"waveform_url":"https://w1.sndcdn.com/uut2Bk2NxmeF_m.png","stream_url":"https://api.soundcloud.com/tracks/76519409/stream","download_url":"https://api.soundcloud.com/tracks/76519409/download","playback_count":76929,"download_count":4163,"favoritings_count":1352,"comment_count":131,"attachments_uri":"https://api.soundcloud.com/tracks/76519409/attachments","policy":"ALLOW"},{"kind":"track","id":70555819,"created_at":"2012/12/09 10:08:09 +0000","user_id":1788517,"duration":1854919,"commentable":true,"state":"finished","original_content_size":44516038,"last_modified":"2015/03/08 23:21:51 +0000","sharing":"public","tag_list":"rone odezenne autechre luke abbott talabot","permalink":"rone-dj-set-radio-nova","streamable":true,"embeddable_by":"all","downloadable":true,"purchase_url":null,"label_id":null,"purchase_title":null,"genre":"","title":"Rone dj set @ Radio Nova (08/12/2012)","description":"1) Odezenne - Saxophone\r\n2) Rone - Bye bye macadam\r\n3) Rocketnumbernine - Matthew & Toby  \r\n4) Autechre - Under boac\r\n5) Benjamin Britten - Op. 7: III. Cuckoo! (Performed by the Monnaie Children's Choir)\r\n6) Luke Abbot - Modern Driveway\r\n7) Matthew dear - Ahead of Myself\r\n8) John Talabot - Lover's tradition\r\n9) vOPhoniQ - Spring","label_name":"","release":"","track_type":"podcast","key_signature":"","isrc":"","video_url":null,"bpm":null,"release_year":null,"release_month":null,"release_day":null,"original_format":"mp3","license":"all-rights-reserved","uri":"https://api.soundcloud.com/tracks/70555819","user":{"id":1788517,"kind":"user","permalink":"rone-music","username":"Rone","last_modified":"2015/02/10 08:56:43 +0000","uri":"https://api.soundcloud.com/users/1788517","permalink_url":"http://soundcloud.com/rone-music","avatar_url":"https://i1.sndcdn.com/avatars-000001787298-keul06-large.jpg"},"permalink_url":"http://soundcloud.com/rone-music/rone-dj-set-radio-nova","artwork_url":"https://i1.sndcdn.com/artworks-000035824689-8uopkn-large.jpg","waveform_url":"https://w1.sndcdn.com/kQVBQGUP4hOO_m.png","stream_url":"https://api.soundcloud.com/tracks/70555819/stream","download_url":"https://api.soundcloud.com/tracks/70555819/download","playback_count":102831,"download_count":2382,"favoritings_count":2186,"comment_count":160,"attachments_uri":"https://api.soundcloud.com/tracks/70555819/attachments","policy":"ALLOW"},{"kind":"track","id":32401381,"created_at":"2012/01/04 17:09:37 +0000","user_id":1788517,"duration":462647,"commentable":true,"state":"finished","original_content_size":18498936,"last_modified":"2015/03/03 00:05:05 +0000","sharing":"public","tag_list":"dominik eulberg rone remix Der tanz der gluehwuermchen traum","permalink":"dominik-eulberg-der-tanz-der","streamable":true,"embeddable_by":"all","downloadable":false,"purchase_url":null,"label_id":null,"purchase_title":null,"genre":"","title":"Dominik Eulberg - Der Tanz der Gluehwuermchen (Rone Remix) [Traum 145]","description":"","label_name":"","release":"","track_type":"remix","key_signature":"","isrc":"","video_url":null,"bpm":null,"release_year":null,"release_month":null,"release_day":null,"original_format":"mp3","license":"all-rights-reserved","uri":"https://api.soundcloud.com/tracks/32401381","user":{"id":1788517,"kind":"user","permalink":"rone-music","username":"Rone","last_modified":"2015/02/10 08:56:43 +0000","uri":"https://api.soundcloud.com/users/1788517","permalink_url":"http://soundcloud.com/rone-music","avatar_url":"https://i1.sndcdn.com/avatars-000001787298-keul06-large.jpg"},"permalink_url":"http://soundcloud.com/rone-music/dominik-eulberg-der-tanz-der","artwork_url":"https://i1.sndcdn.com/artworks-000016407955-5p0ot7-large.jpg","waveform_url":"https://w1.sndcdn.com/l7BZgoFTq6oW_m.png","stream_url":"https://api.soundcloud.com/tracks/32401381/stream","playback_count":218892,"download_count":0,"favoritings_count":4967,"comment_count":240,"attachments_uri":"https://api.soundcloud.com/tracks/32401381/attachments","policy":"ALLOW"},{"kind":"track","id":18263243,"created_at":"2011/07/02 12:09:59 +0000","user_id":1788517,"duration":284999,"commentable":true,"state":"finished","original_content_size":11395688,"last_modified":"2015/03/14 18:45:47 +0000","sharing":"public","tag_list":"rone nakt infiné infinemusic","permalink":"rone-nakt-if2034-2011","streamable":true,"embeddable_by":"all","downloadable":false,"purchase_url":"http://itunes.apple.com/fr/album/so-so-so-single/id435974040","label_id":null,"purchase_title":null,"genre":"","title":"Rone - Nakt [IF2034]","description":"","label_name":"","release":"","track_type":"","key_signature":"","isrc":"","video_url":null,"bpm":null,"release_year":null,"release_month":null,"release_day":null,"original_format":"mp3","license":"all-rights-reserved","uri":"https://api.soundcloud.com/tracks/18263243","user":{"id":1788517,"kind":"user","permalink":"rone-music","username":"Rone","last_modified":"2015/02/10 08:56:43 +0000","uri":"https://api.soundcloud.com/users/1788517","permalink_url":"http://soundcloud.com/rone-music","avatar_url":"https://i1.sndcdn.com/avatars-000001787298-keul06-large.jpg"},"permalink_url":"http://soundcloud.com/rone-music/rone-nakt-if2034-2011","artwork_url":"https://i1.sndcdn.com/artworks-000008854168-x5ujvp-large.jpg","waveform_url":"https://w1.sndcdn.com/W7gIL68HgEe0_m.png","stream_url":"https://api.soundcloud.com/tracks/18263243/stream","playback_count":160436,"download_count":0,"favoritings_count":3621,"comment_count":172,"attachments_uri":"https://api.soundcloud.com/tracks/18263243/attachments","policy":"ALLOW"},{"kind":"track","id":5666611,"created_at":"2010/09/29 11:59:58 +0000","user_id":1788517,"duration":425382,"commentable":true,"state":"finished","original_content_size":17008872,"last_modified":"2015/02/28 10:51:30 +0000","sharing":"public","tag_list":"rone infine bora","permalink":"flesh","streamable":true,"embeddable_by":"all","downloadable":false,"purchase_url":"http://itunes.apple.com/fr/album/bora/id287791858","label_id":217329,"purchase_title":null,"genre":"Electronic","title":"Rone - Flesh [IF2009]","description":"","label_name":"Infinemusic","release":"IF2009","track_type":"","key_signature":"","isrc":"","video_url":null,"bpm":null,"release_year":2008,"release_month":1,"release_day":1,"original_format":"mp3","license":"all-rights-reserved","uri":"https://api.soundcloud.com/tracks/5666611","user":{"id":1788517,"kind":"user","permalink":"rone-music","username":"Rone","last_modified":"2015/02/10 08:56:43 +0000","uri":"https://api.soundcloud.com/users/1788517","permalink_url":"http://soundcloud.com/rone-music","avatar_url":"https://i1.sndcdn.com/avatars-000001787298-keul06-large.jpg"},"label":{"id":217329,"kind":"user","permalink":"jayinfineberlin","username":"Julien / inFiné","last_modified":"2015/03/11 13:01:59 +0000","uri":"https://api.soundcloud.com/users/217329","permalink_url":"http://soundcloud.com/jayinfineberlin","avatar_url":"https://i1.sndcdn.com/avatars-000112514936-ptjbb5-large.jpg"},"permalink_url":"http://soundcloud.com/rone-music/flesh","artwork_url":"https://i1.sndcdn.com/artworks-000002474189-o1huae-large.jpg","waveform_url":"https://w1.sndcdn.com/YR7Q5rZ5zvBE_m.png","stream_url":"https://api.soundcloud.com/tracks/5666611/stream","playback_count":50898,"download_count":0,"favoritings_count":774,"comment_count":45,"attachments_uri":"https://api.soundcloud.com/tracks/5666611/attachments","policy":"ALLOW"},{"kind":"track","id":5666465,"created_at":"2010/09/29 11:50:47 +0000","user_id":1788517,"duration":339250,"commentable":true,"state":"finished","original_content_size":13564894,"last_modified":"2015/03/15 16:27:16 +0000","sharing":"public","tag_list":"rone damasio infine bora","permalink":"bora-vocal","streamable":true,"embeddable_by":"all","downloadable":false,"purchase_url":"http://itunes.apple.com/fr/album/bora/id287791858","label_id":217329,"purchase_title":null,"genre":"Electronic","title":"Rone - Bora (vocal) [iF1005]","description":"","label_name":"Infinemusic","release":"IF2009","track_type":"","key_signature":"","isrc":"","video_url":"http://vimeo.com/2439316","bpm":null,"release_year":2008,"release_month":1,"release_day":1,"original_format":"mp3","license":"all-rights-reserved","uri":"https://api.soundcloud.com/tracks/5666465","user":{"id":1788517,"kind":"user","permalink":"rone-music","username":"Rone","last_modified":"2015/02/10 08:56:43 +0000","uri":"https://api.soundcloud.com/users/1788517","permalink_url":"http://soundcloud.com/rone-music","avatar_url":"https://i1.sndcdn.com/avatars-000001787298-keul06-large.jpg"},"label":{"id":217329,"kind":"user","permalink":"jayinfineberlin","username":"Julien / inFiné","last_modified":"2015/03/11 13:01:59 +0000","uri":"https://api.soundcloud.com/users/217329","permalink_url":"http://soundcloud.com/jayinfineberlin","avatar_url":"https://i1.sndcdn.com/avatars-000112514936-ptjbb5-large.jpg"},"permalink_url":"http://soundcloud.com/rone-music/bora-vocal","artwork_url":"https://i1.sndcdn.com/artworks-000002474210-cxisqw-large.jpg","waveform_url":"https://w1.sndcdn.com/9hV7kJD4fnm3_m.png","stream_url":"https://api.soundcloud.com/tracks/5666465/stream","playback_count":183418,"download_count":0,"favoritings_count":4000,"comment_count":214,"attachments_uri":"https://api.soundcloud.com/tracks/5666465/attachments","policy":"ALLOW"}]""")

    def readSoundCloudTracks(soundCloudJsonResponse: JsValue, artist: Artist): Seq[Track] = {
      val soundCloudTrackReads = (
        (__ \ "stream_url").readNullable[String] and
          (__ \ "title").readNullable[String] and
          (__ \ "permalink_url").readNullable[String] and
          (__ \ "user" \ "avatar_url").readNullable[String] and
          (__ \ "artwork_url").readNullable[String]
        )((url: Option[String], title: Option[String], redirectUrl: Option[String], avatarUrl: Option[String],
           thumbnail: Option[String]) => (url, title, redirectUrl, thumbnail, avatarUrl))
      val onlyTracksWithUrlTitleAndThumbnail =
        Reads.seq(soundCloudTrackReads).map { collectOnlyTracksWithUrlTitleAndThumbnail(_, artist) }

      soundCloudJsonResponse
        .asOpt[Seq[Track]](onlyTracksWithUrlTitleAndThumbnail)
        .getOrElse(Seq.empty)
    }

    def collectOnlyTracksWithUrlTitleAndThumbnail(tracks: Seq[(Option[String], Option[String], Option[String],
      Option[String], Option[String])], artist: Artist): Seq[Track] = {
      println(tracks)
      val a = tracks.collect {
        case (Some(url), Some(title), redirectUrl: Option[String], Some(thumbnailUrl: String), avatarUrl) =>
          Track(-1L, normalizeTrackTitle(title, artist.name), url, "Soundcloud", thumbnailUrl, artist.facebookUrl,
            redirectUrl)
        case (Some(url), Some(title), redirectUrl: Option[String], None, Some(avatarUrl: String)) =>
          Track(-1L, normalizeTrackTitle(title, artist.name), url, "Soundcloud", avatarUrl, artist.facebookUrl,
            redirectUrl)
      }
      println(a)
      a
    }
    //+ artistName_ (ou : / etc)
    def normalizeTrackTitle(title: String, artistName: String): String =
      ("""(?i)""" + Pattern.quote(artistName) + """\s*-?\s*""").r.replaceFirstIn(
        """(?i)(\.wm[a|v]|\.ogc|\.amr|\.wav|\.flv|\.mov|\.ram|\.mp[3-5]|\.pcm|\.alac|\.eac-3|\.flac|\.vmd)\s*$""".r
          .replaceFirstIn(title, ""),
        "")

    Ok(Json.toJson(readSoundCloudTracks(a, new Artist(1, Some("jjhkj"), "rone", facebookUrl = "facebookUrl"))))
    //Ok(a)
  }
}
